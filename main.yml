- name: Server setup
  hosts: local

  vars:
    cloudflared_tunnel_token: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      63633039353231343463346531666663393036623930353932656538373937613430343764393763
      6563653063363864363061386665303234396366363137330a383263366238333936333066396434
      38346664303333616265396338343161643734396466373133356465303666376135653634633666
      6634343130323537660a613861636235323234383235343436613734643237663364393233373966
      37663730346534663339396536333465353530386263653530336630363661303939356334343765
      33616663386263646237663732313735396136336232306463396533613766366139373665326530
      33643230663866336235353530393865623132346163303666323035613530366661643838633133
      64616138663461616234303663343237626338353863646461353932323832383561663231383761
      62626534313037363532323964323236326632666533356366336437353763303434316264316637
      39666532356638333137653437336664313538386631373462666235376462383138303264383636
      34396636376436336266366533306366333635323837346466623963653462643835313464626530
      38343364303536316462666339316465323165323762303163333132363737376366653238396664
      35313465336664356630343137633832316261653435336633633164383131656164

    security_door_camera_address: "10.0.50.200"
    security_door_camera_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      63373262316261323435653934656666623735636133623065623237393835323337313336323937
      3131396664383433636139363439313866363830643261360a666231626362653966386532383164
      36623633623432393833303732396436656335626263393461313163383839353038353461666264
      3431643937376337330a636432636336643431643862303033316464393563313733313565313362
      33343963356131323964346632663066336365613465353632353866373961626430

    paisa_user: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      34376430366664613865633235323239376434303961303134613331323233633163616534383937
      6337333732323733363865613830343463383765666265320a646231336432373630346237623565
      63343763316233323338373338633832303333626564653831636138326134646333353735623330
      6161383530303061310a356363333837396336613766356631363663613338356663393630623437
      3531
    paisa_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      65376636633234613339383730326362646266646633393465356130363636326563333836653439
      3631636234633263323363306439663665376261353962380a643035636361616562303838626165
      37326263373166376563306464656566303066376536353935336364653265313931383738613065
      3930303764396139300a386138346634626438646333313430313135643365653033323331313933
      3364

    backup_encryption_passphrase: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      33303936626239363932626666393764376439656363323661333263663861633338373033333835
      6561613037653439316664633133393561616634316134660a613934333363363535363763363537
      37303130353830303061333937373534663230353636353163626232353635666664306136323466
      3332663834653131330a646666363830323433393662663139323462646463356161336637366336
      30386634366366326539306363323537393665376563396336633163666461313862376237323838
      3436386331356262316161333730386130666135303837393866
    backup_ssh_user: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      36326365633935623032626433626233613438616363316530383337333430353962353664376330
      3964383636383033316233393032356332313335313837310a373434326563323466363565323964
      63383233613330303137336331356265643661336138393532353165373139356634366638626565
      6363656362326334380a303264393963343330396234616464326230613632313139366134363535
      3039
    backup_ssh_host: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      62343239323438653236626437653630666230386662356464336663666335333934343031393666
      3265373762653566393161643962666563353763383266300a306635313665386133653931366465
      32306231306361303063346463396236623137656139663439623332323262633538633136393232
      3838383034633539650a386337393662383537643234306635313763633765363961643531393365
      63316130383836613666353137363031313361616137333338653733633766303761
    backup_ssh_port: 23
    backup_ssh_directory: "~/repository0"
    backup_ssh_key_public: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOc8NJi9+m8Ros3b1hDUIUX/sHh4EU26+CoWeQZ5e2rQ
    backup_ssh_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      65356231356661303837336666623437636462383635356561376631303834333639333635633662
      3561383963313339366461623665383238653537366339340a333965356536623133346364393632
      34386562663664333939633230346532626430353965343263646632633232383737346266306665
      3939616235636430330a323030653833306433336233343563653830363039306131623762363635
      39653862646138623634666232333139643436343134316461653431386366346666626136386331
      63383635306630666537623739396334663139353836626464653639626562323462393233303161
      63363833313566623934633766643738653035383436623636616537386461616136316366366665
      33386261363633323233393161306539373362326661616533376533313235373533323766303336
      37623633623132316630643337396238616534633961633062316364343433336332373330373339
      62653464363931346235333737646364343437366233653765343464633630623035636232306465
      63366237663437333536616532666636353036636132393832326162343038643036303038336532
      31356361303139613962323766313334643062616665356138336231313465343965613933393430
      66306461623834383036323339653838623632643538616564646139363163396331636630353132
      39626330313063656537396233316334303238386131383061313131663137376566616562346462
      30346265646434636330303738313035613061616362333835326537653930303730636332363765
      31346538653639373764383237356533396135626566333135613364353835393738663461646134
      66643036326264353734353538306166393965323531336133393962303063613236386437343835
      31363131313335396366303038363334633639656534313335396265363933306464346336623239
      34396237386563353438303538643236613331646361666262386262633936613962396463333330
      30363535336262643033323235623837353236653331633836626430306437353133656638346336
      30613930383437666165313631333830353239613031656261323765323631373133303133636236
      37333365313835383963613033626361633238383961663061616361643039633838636561636430
      38643966626466336531333862623432386263656233393934386131356432363164623039646262
      34663332613432623065

  roles:
    - role: setup
      vars:
        ansible_become_password: '{{ lookup("env", "ANSIBLE_BECOME_PASSWORD") }}'
        backup_user: "backupuser"
        backup_ssh_key_path: "/home/backupuser/.ssh/backup"
        backup_ssh_key_content: "{{ backup_ssh_key }}"
        backup_ssh_key_public_content: "{{ backup_ssh_key_public }}"
        backup_ssh_host: "{{ backup_ssh_user }}@{{ backup_ssh_host }}:{{ backup_ssh_port }}"

    - role: borgbase.ansible_role_borgbackup
      become: true
      borg_encryption_passphrase: "{{ backup_encryption_passphrase }}"
      borg_repository: ssh://{{ backup_ssh_user }}@{{ backup_ssh_host }}:{{ backup_ssh_port }}/{{ backup_ssh_directory }}
      borg_ssh_command: "ssh -i /home/backupuser/.ssh/backup"
      borg_ssh_key_name: "backup"
      borg_user: "backupuser"
      borg_group: "backupuser"
      borgmatic_timer: systemd
      borgmatic_timer_hour: 3
      borgmatic_timer_minute: 0
      borg_retention_policy:
        keep_hourly: 6
        keep_daily: 3
        keep_weekly: 2
      borg_source_directories: ["/media/homelab/data"]
      borgmatic_hooks:
        sqlite_databases:
          - name: frigate
            path: /media/homelab/data/frigate/config/frigate.db
      vars:
        ansible_become_password: '{{ lookup("env", "ANSIBLE_BECOME_PASSWORD") }}'

    - role: cloudflared
      vars:
        cloudflared_project_name: cloudflared
        cloudflared_tunnel_name: cloudflared
        cloudflared_container_name: cloudflared
        cloudflared_network_name: cloudflared
        cloudflared_token: "{{ cloudflared_tunnel_token }}"

    - role: frigate
      vars:
        frigate_rtsp_stream1: "rtsp://admin:{{ security_door_camera_password }}@{{ security_door_camera_address }}:554/stream1"
        frigate_rtsp_stream2: "rtsp://admin:{{ security_door_camera_password }}@{{ security_door_camera_address }}:554/stream2"
        frigate_container_name: frigate
        frigate_project_name: frigate
        frigate_image: ghcr.io/blakeblackshear/frigate:0.15.2-rocm
        frigate_data_dir: /media/homelab/data/frigate
        frigate_config_file: /media/homelab/data/frigate/config/config.yml
        frigate_network_name: cloudflared
        ansible_become_password: '{{ lookup("env", "ANSIBLE_BECOME_PASSWORD") }}'

    - role: paisa
      vars:
        paisa_project_name: paisa
        paisa_container_name: paisa
        paisa_user_name: "{{ paisa_user }}"
        paisa_user_password: "{{ paisa_password }}"
        paisa_data_dir: /media/homelab/data/paisa
        paisa_network_name: cloudflared
